name: CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH into Server and Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Enable debugging mode
            set -x

            # Change directory to project
            cd /home/ubuntu/fastapi-book-project || { echo "Directory not found"; exit 1; }

            # Pull latest changes from Git
            git pull origin main || { echo "Git pull failed"; exit 1; }

            # Check disk space
            df -h

            # List current processes
            ps aux | grep python

            # Stop and remove existing containers
            docker-compose down || { echo "Failed to stop containers"; exit 1; }

            # Remove unused Docker images to free up space
            docker system prune -af || { echo "Docker prune failed"; exit 1; }

            # Build and start containers
            docker-compose up -d --build || { echo "Docker build failed"; exit 1; }

            # List running Docker containers
            docker ps -a

            # Display logs of the main application container
            docker logs $(docker-compose ps -q app) || { echo "Failed to fetch logs"; exit 1; }

            # Exit debug mode
            set +x
